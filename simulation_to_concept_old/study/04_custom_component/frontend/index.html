<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Simulation Bridge Component</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .simulation-frame {
            flex: 1;
            width: 100%;
            border: none;
        }
        
        .status-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 12px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .change-count {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container" id="container">
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div>Loading simulation...</div>
        </div>
        
        <div class="status-bar" id="statusBar" style="display: none;">
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span>Listening for student interactions</span>
            </div>
            <div class="change-count" id="changeCount">0 changes detected</div>
        </div>
        
        <iframe 
            id="simulationFrame"
            class="simulation-frame"
            style="display: none;"
            scrolling="yes"
            allowfullscreen>
        </iframe>
    </div>

    <script>
        // Streamlit Component Communication
        // ==================================
        
        // Track state
        let changeCount = 0;
        let lastParams = null;
        
        // Initialize Streamlit connection
        function sendMessageToStreamlit(type, data) {
            const outData = Object.assign({
                isStreamlitMessage: true,
                type: type,
            }, data);
            window.parent.postMessage(outData, "*");
        }

        // Tell Streamlit we're ready
        function onReady() {
            sendMessageToStreamlit("streamlit:componentReady", {apiVersion: 1});
        }

        // Tell Streamlit the component height
        function setFrameHeight(height) {
            sendMessageToStreamlit("streamlit:setFrameHeight", {height: height});
        }

        // Send value back to Streamlit (this is what the Python component receives)
        function sendValueToStreamlit(value) {
            sendMessageToStreamlit("streamlit:setComponentValue", {value: value});
        }

        // Handle messages from Streamlit
        function handleStreamlitMessage(event) {
            const data = event.data;
            
            // Check if it's a Streamlit render message
            if (data.type !== "streamlit:render") return;
            
            const args = data.args;
            console.log("[SimBridge] Received render args:", args);
            
            // Hide loading, show simulation
            document.getElementById('loading').style.display = 'none';
            document.getElementById('statusBar').style.display = 'flex';
            const iframe = document.getElementById('simulationFrame');
            iframe.style.display = 'block';
            
            // Set iframe source and height
            if (args.simulation_url) {
                iframe.src = args.simulation_url;
            }
            if (args.height) {
                iframe.style.height = (args.height - 40) + 'px';  // Account for status bar
                setFrameHeight(args.height);
            }
            
            // Store initial params for comparison
            lastParams = args.initial_params || {};
        }

        // Listen for postMessage from the simulation iframe
        function handleSimulationMessage(event) {
            // Ignore messages from Streamlit itself
            if (event.data.isStreamlitMessage) return;
            if (event.data.type === "streamlit:render") return;
            
            const data = event.data;
            console.log("[SimBridge] Message from simulation:", data);
            
            // Check if it's a simulation parameter change
            if (data.type === 'SIMULATION_PARAM_CHANGE' || 
                data.type === 'PARAM_CHANGE' ||
                data.param !== undefined ||
                data.parameter !== undefined) {
                
                // Normalize the data format
                const normalized = normalizeParamChange(data);
                
                // Update UI
                changeCount++;
                document.getElementById('changeCount').textContent = 
                    `${changeCount} change${changeCount !== 1 ? 's' : ''} detected`;
                
                // Send to Streamlit!
                console.log("[SimBridge] Sending to Streamlit:", normalized);
                sendValueToStreamlit(normalized);
            }
        }

        // Normalize different message formats from simulations
        function normalizeParamChange(data) {
            // Format 1: {type: 'SIMULATION_PARAM_CHANGE', change: {...}, allParams: {...}}
            if (data.change && data.allParams) {
                return data;
            }
            
            // Format 2: {param: 'length', value: 5, oldValue: 3}
            if (data.param !== undefined) {
                return {
                    type: 'SIMULATION_PARAM_CHANGE',
                    change: {
                        param: data.param,
                        oldValue: data.oldValue || lastParams[data.param],
                        newValue: data.value
                    },
                    allParams: {...lastParams, [data.param]: data.value},
                    timestamp: Date.now(),
                    source: 'simulation'
                };
            }
            
            // Format 3: {parameter: 'length', newValue: 5}
            if (data.parameter !== undefined) {
                return {
                    type: 'SIMULATION_PARAM_CHANGE',
                    change: {
                        param: data.parameter,
                        oldValue: data.previousValue || lastParams[data.parameter],
                        newValue: data.newValue
                    },
                    allParams: {...lastParams, [data.parameter]: data.newValue},
                    timestamp: Date.now(),
                    source: 'simulation'
                };
            }
            
            // Unknown format, pass through with wrapper
            return {
                type: 'SIMULATION_PARAM_CHANGE',
                rawData: data,
                timestamp: Date.now(),
                source: 'simulation'
            };
        }

        // Set up event listeners
        window.addEventListener('message', function(event) {
            handleStreamlitMessage(event);
            handleSimulationMessage(event);
        });

        // Tell Streamlit we're ready
        onReady();
        
        console.log("[SimBridge] Component initialized, listening for messages...");
    </script>
</body>
</html>
