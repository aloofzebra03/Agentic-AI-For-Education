<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Character Animation</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: transparent;
      font-family: Arial, sans-serif;
    }
    .character-overlay {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      width: 200px;
      height: 240px;
      background: rgba(255, 255, 255, 0.95);
      border: 3px solid #7c3aed;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .character-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      box-sizing: border-box;
    }
    
    .character-image {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 2px solid #7c3aed;
      object-fit: cover;
    }
    
    .mouth-container {
      position: absolute;
      left: 50%;
      top: 75px;
      transform: translateX(-50%);
      width: 60px;
      height: 25px;
      pointer-events: none;
    }
    
    svg.mouth { width: 100%; height: 100%; }
    .mouth-set g { opacity: 0; transition: opacity 80ms ease-out; }
    .mouth-set g.active { opacity: 1; }
    
    .character-name {
      margin-top: 15px;
      font-family: 'Segoe UI', sans-serif;
      font-size: 12px;
      font-weight: bold;
      color: #7c3aed;
      text-align: center;
    }
    
    .status-indicator {
      position: absolute;
      top: -5px;
      right: -5px;
      width: 15px;
      height: 15px;
      background: #22c55e;
      border-radius: 50%;
      border: 2px solid white;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .status-indicator.speaking {
      opacity: 1;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
  </style>
</head>
<body>
  <div class="character-overlay">
    <div class="character-container">
      <div class="status-indicator" id="speaking-indicator"></div>
      <img id="character-image" src="{{CHARACTER_IMAGE}}" class="character-image" alt="{{CHARACTER_NAME}}" />
      <div class="mouth-container">
        <svg class="mouth" viewBox="-50 -50 100 100">
          <g class="mouth-set" id="mouthSet">
            <g data-viseme="rest" class="active"><path d="M-26 6 q26 10 52 0" fill="#c33" stroke="#000" stroke-width="1"/></g>
            <g data-viseme="closed"><rect x="-30" y="-6" width="60" height="12" rx="6" fill="#9b2b2b"/></g>
            <g data-viseme="wide"><ellipse cx="0" cy="6" rx="42" ry="14" fill="#9b2b2b"/></g>
            <g data-viseme="open"><ellipse cx="0" cy="8" rx="36" ry="22" fill="#9b2b2b"/></g>
            <g data-viseme="round"><ellipse cx="0" cy="6" rx="22" ry="26" fill="#9b2b2b"/></g>
            <g data-viseme="f_v">
              <path d="M-28 6 q28 -24 56 0" fill="none" stroke="#000" stroke-width="3" />
              <rect x="-20" y="2" width="40" height="6" rx="3" fill="#9b2b2b" />
            </g>
            <g data-viseme="th">
              <rect x="-18" y="0" width="36" height="8" rx="4" fill="#9b2b2b" />
              <rect x="-6" y="-8" width="12" height="8" rx="3" fill="#ffe8d6" />
            </g>
            <g data-viseme="smush"><ellipse cx="0" cy="6" rx="28" ry="12" fill="#9b2b2b"/></g>
            <g data-viseme="kiss"><ellipse cx="0" cy="6" rx="16" ry="12" fill="#9b2b2b"/></g>
          </g>
        </svg>
      </div>
      <div class="character-name">{{CHARACTER_NAME}}</div>
    </div>
    
    <audio id="characterAudio" preload="auto" style="display: none;">
      <source src="data:audio/wav;base64,{{AUDIO_BASE64}}" type="audio/wav">
    </audio>
  </div>

  <script>
    // Configuration data injected by Python template substitution
    const CONFIG = {
      text: "{{TEXT}}",
      character: "{{CHARACTER_TYPE}}",
      audioBase64: "{{AUDIO_BASE64}}"
    };

    // Animation elements
    const mouthSet = document.getElementById("mouthSet");
    const speakingIndicator = document.getElementById("speaking-indicator");
    const characterAudio = document.getElementById("characterAudio");
    
    // Animation state
    let queue = [], timer = null, playing = false, forceStop = false;

    // Core animation functions (copied directly from animation.html)
    function simpleG2P(text) {
      let s = text.toLowerCase().replace(/[^a-z\s]/g, ' ');
      const tokens = [];
      for (let i = 0; i < s.length;) {
        if (s[i] === " ") { i++; continue }
        const dig = s.slice(i, i + 2);
        if (['ch', 'sh', 'th', 'ng', 'ph', 'qu', 'ck', 'wh'].includes(dig)) { 
          tokens.push(dig); 
          i += 2; 
          continue 
        }
        tokens.push(s[i]); 
        i++;
      }
      return tokens;
    }

    function phonemeToViseme(p) {
      if (['p', 'b', 'm'].includes(p)) return 'closed';
      if (['a', 'o'].includes(p)) return 'open';
      if (['e', 'i', 'y'].includes(p)) return 'wide';
      if (['u', 'oo', 'w'].includes(p)) return 'round';
      if (['f', 'v'].includes(p)) return 'f_v';
      if (['th', 't', 'd', 'n'].includes(p)) return 'th';
      if (['s', 'z', 'sh', 'ch', 'j'].includes(p)) return 'smush';
      if (['q'].includes(p)) return 'kiss';
      return 'rest';
    }

    function estimateDur(tok) {
      return /[aeiou]/.test(tok) ? 140 : 90;
    }

    function prepareQueue(text) {
      const toks = simpleG2P(text);
      const frames = toks.map(t => ({ vis: phonemeToViseme(t), dur: estimateDur(t) }));
      const comp = [];
      for (const f of frames) {
        const last = comp[comp.length - 1];
        if (last && last.vis === f.vis) last.dur += f.dur;
        else comp.push({ ...f });
      }
      return comp;
    }

    function setViseme(v) {
      mouthSet.querySelectorAll("[data-viseme]").forEach(g => g.classList.remove("active"));
      const el = mouthSet.querySelector(`[data-viseme="${v}"]`);
      if (el) el.classList.add("active");
    }

    function stepQueue() {
      if (!playing || forceStop) return;
      if (queue.length === 0) { 
        setViseme("rest"); 
        playing = false;
        speakingIndicator.classList.remove("speaking");
        return;
      }
      const frame = queue.shift();
      setViseme(frame.vis);
      timer = setTimeout(stepQueue, frame.dur);
    }

    function startLipSync(text) {
      if (!text || !text.trim()) return;
      
      queue = prepareQueue(text);
      if (queue.length > 0) {
        playing = true;
        forceStop = false;
        speakingIndicator.classList.add("speaking");
        stepQueue();
      }
    }

    function stopLipSync() {
      playing = false;
      forceStop = true;
      queue = [];
      if (timer) {
        clearTimeout(timer);
        timer = null;
      }
      setViseme("rest");
      speakingIndicator.classList.remove("speaking");
    }

    // Initialize animation
    function initialize() {
      setViseme("rest");
      
      // Handle audio events
      if (characterAudio && CONFIG.audioBase64) {
        characterAudio.addEventListener('play', () => {
          startLipSync(CONFIG.text);
        });
        
        characterAudio.addEventListener('ended', stopLipSync);
        characterAudio.addEventListener('pause', stopLipSync);
        
        // Auto-play the audio
        characterAudio.play().catch(e => console.log('Auto-play prevented:', e));
      } else if (CONFIG.text) {
        // If no audio provided, just start the lip sync animation
        startLipSync(CONFIG.text);
      }
    }

    // Start when page loads
    window.onload = initialize;
  </script>
</body>
</html>
